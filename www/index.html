<?xml version="1.0"?>
<!DOCTYPE html>
<html>
	<head>
		<title>Energiemeter</title>
		
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		
        <link rel="stylesheet" type="text/css" href="day.css">
        
		<!-- 1/3. Include the RGraph libraries -->
		<script src="javascript/rgraph/RGraph.common.core.js" ></script>
		<script src="javascript/rgraph/RGraph.common.dynamic.js" ></script>
		<script src="javascript/rgraph/RGraph.common.effects.js" ></script>
		<script src="javascript/rgraph/RGraph.gauge.js" ></script>
		<script src="javascript/rgraph/RGraph.line.js" ></script>
		<script src="javascript/rgraph/RGraph.scatter.js" ></script>
		<script src="javascript/rgraph/RGraph.drawing.text.js" ></script>
                                                                                                             
</script>

	</head>
	<body>
        <div style="text-align: center">
            <a href="#" class="buttonDay" id="btn_day_1" onclick="showDay('1')">Maandag</a>
            <a href="#" class="buttonDay" id="btn_day_2" onclick="showDay('2')">Dinsdag</a>
            <a href="#" class="buttonDay" id="btn_day_3" onclick="showDay('3')">Woensdag</a>
            <a href="#" class="buttonDay" id="btn_day_4" onclick="showDay('4')">Donderdag</a>
            <a href="#" class="buttonDay" id="btn_day_5" onclick="showDay('5')">Vrijdag</a>
            <a href="#" class="buttonDay" id="btn_day_6" onclick="showDay('6')">Zaterdag</a>
            <a href="#" class="buttonDay" id="btn_day_7" onclick="showDay('7')">Zondag</a>
        </div>
		<div style="text-align: center">
            <a href="#" class="buttonHour" id="btn_hour_1"  onclick="showHour( '1')">1</a>
            <a href="#" class="buttonHour" id="btn_hour_2"  onclick="showHour( '2')">2</a>
            <a href="#" class="buttonHour" id="btn_hour_3"  onclick="showHour( '3')">3</a>
            <a href="#" class="buttonHour" id="btn_hour_4"  onclick="showHour( '4')">4</a>
            <a href="#" class="buttonHour" id="btn_hour_5"  onclick="showHour( '5')">5</a>
            <a href="#" class="buttonHour" id="btn_hour_6"  onclick="showHour( '6')">6</a>
            <a href="#" class="buttonHour" id="btn_hour_7"  onclick="showHour( '7')">7</a>
            <a href="#" class="buttonHour" id="btn_hour_8"  onclick="showHour( '8')">8</a>
            <a href="#" class="buttonHour" id="btn_hour_9"  onclick="showHour( '9')">9</a>
            <a href="#" class="buttonHour" id="btn_hour_10" onclick="showHour('10')">10</a>
            <a href="#" class="buttonHour" id="btn_hour_11" onclick="showHour('11')">11</a>
            <a href="#" class="buttonHour" id="btn_hour_12" onclick="showHour('12')">12</a>
            <a href="#" class="buttonHour" id="btn_hour_13" onclick="showHour('13')">13</a>
            <a href="#" class="buttonHour" id="btn_hour_14" onclick="showHour('14')">14</a>
            <a href="#" class="buttonHour" id="btn_hour_15" onclick="showHour('15')">15</a>
            <a href="#" class="buttonHour" id="btn_hour_16" onclick="showHour('16')">16</a>
            <a href="#" class="buttonHour" id="btn_hour_17" onclick="showHour('17')">17</a>
            <a href="#" class="buttonHour" id="btn_hour_18" onclick="showHour('18')">18</a>
            <a href="#" class="buttonHour" id="btn_hour_19" onclick="showHour('19')">19</a>
            <a href="#" class="buttonHour" id="btn_hour_20" onclick="showHour('20')">20</a>
            <a href="#" class="buttonHour" id="btn_hour_21" onclick="showHour('21')">21</a>
            <a href="#" class="buttonHour" id="btn_hour_22" onclick="showHour('22')">22</a>
            <a href="#" class="buttonHour" id="btn_hour_23" onclick="showHour('23')">23</a>
            <a href="#" class="buttonHour" id="btn_hour_24" onclick="showHour('24')">24</a>
        </div>
		<div style="text-align: center">
			<canvas id="cvs0" width="475" height="300">[No canvas support]</canvas>
			<canvas id="cvs1" width="300" height="300">[No canvas support]</canvas>
        </div>
		<div style="text-align: center">
			<canvas id="cvs2" width="795" height="300">[No canvas support]</canvas>
        </div>
		<div style="text-align: center">
			<canvas id="cvs3" width="795" height="300">[No canvas support]</canvas>
		</div>
		
		<!--
        	3/3. This creates and displays the graph. As it is here, you can call this from the window.onload event,
            allowing you to put it in your pages header.
        -->
        <script>    
        	var day = 0;
        	var hour = 0;
       		var gauge = null;
        	var previousMaxLastHour = 0;
	
        	window.onload = function ()
        	{
                update();
            }

			function update()
			{
				RGraph.AJAX.getJSON('data.php?set=data_' + day + '_' + hour, draw);
            
				if ((day == 0) && (hour == 0)) {
        			setTimeout(update, 10000);
        		}
			}

        	/**
        	 * This is the AJAX callback function. 
        	 */
        	function draw (jsonData)
        	{
        		drawTextCanvas('cvs0', jsonData);
        		
        		// calculate max based on last 60 minutes data
        		var maxLastHour = Math.max.apply(Math, jsonData.eLastHourList);
                var scale = (maxLastHour >= 1000) ? 1000 : 200;
                var yMax = scale + (maxLastHour - (maxLastHour % scale));
                var yLabelsCount = yMax / scale;
                if (yLabelsCount <= 3) {
                	yLabelsCount *= 2;
                }

	        	drawGauge('cvs1', jsonData, maxLastHour, yMax, yLabelsCount);
                
	        	drawHourGraph('cvs2', jsonData, yMax, yLabelsCount);
	        	
	        	drawDayGraphMinMaxAvg('cvs3', jsonData);
	        	
        	}
        	
        	function drawTextCanvas(canvasName, jsonData) {
                RGraph.Reset(document.getElementById(canvasName));
        		
                var textSize = 14;
                var inbetweenLineSize = 10;
                var x1 = 40;
                var x2 = 400;
        		var y = 100;

        		new RGraph.Drawing.Text(canvasName, x1, y, 'Meeting:')
        			.Set('valign', 'bottom')
        			.Set('halign', 'left')
        			.Set('size', textSize)
        			.Draw();
        			
        		new RGraph.Drawing.Text(canvasName, x2, y, jsonData.timestamp)
        			.Set('valign', 'bottom')
        			.Set('halign', 'right')
        			.Set('size', textSize)
        			.Draw();
        			
        		y += textSize + inbetweenLineSize;
        		new RGraph.Drawing.Text(canvasName, x1, y, 'Elektra dag totaal:')
        			.Set('valign', 'bottom')
        			.Set('halign', 'left')
        			.Set('size', textSize)
        			.Draw();
        		
        		var dayTotal = '?';
        		if (jsonData.eHourlyTotalList[0] != null) {
        			dayTotal = (jsonData.eTotal - jsonData.eHourlyTotalList[0]) / 1000;
        		}
        		new RGraph.Drawing.Text(canvasName, x2, y, dayTotal.toString() + ' kWh')
        			.Set('valign', 'bottom')
        			.Set('halign', 'right')
        			.Set('size', textSize)
        			.Draw();
        		
        		y += textSize + inbetweenLineSize;
        		new RGraph.Drawing.Text(canvasName, x1, y, 'Elektra dag minimum:')
        			.Set('valign', 'bottom')
        			.Set('halign', 'left')
        			.Set('size', textSize)
        			.Draw();

        		new RGraph.Drawing.Text(canvasName, x2, y, jsonData.eDayMin.toString() + ' W')
        			.Set('valign', 'bottom')
        			.Set('halign', 'right')
        			.Set('size', textSize)
        			.Draw();
        		
        		y += textSize + inbetweenLineSize;
        		new RGraph.Drawing.Text(canvasName, x1, y, 'Elektra dag maximum:')
        			.Set('valign', 'bottom')
        			.Set('halign', 'left')
        			.Set('size', textSize)
        			.Draw();
        			
        		new RGraph.Drawing.Text(canvasName, x2, y, jsonData.eDayMax.toString() + ' W')
        			.Set('valign', 'bottom')
        			.Set('halign', 'right')
        			.Set('size', textSize)
        			.Draw();
        	}
        	
        	function drawGauge(canvasId, jsonData, maxLastHour, yMax, yLabelsCount) {
        		// Update gauge
        		if (maxLastHour != previousMaxLastHour) {
        			previousMaxLastHour = maxLastHour;
        			
        			RGraph.Reset(document.getElementById(canvasId));
        			gauge = new RGraph.Gauge(canvasId, 0, yMax, 0)
        				.Set('title.top', 'Energie verbruik')
        				.Set('chart.scale.thousand', '')
        				.Set('chart.tickmarks.big', yLabelsCount)
        				.Set('chart.labels.count', yLabelsCount)
        				.Set('chart.tickmarks.small', yLabelsCount * 5);
        		}
        			
        		var text = jsonData.eNow + ' W';
                gauge.Set('title.bottom', text);
                gauge.value = jsonData.eNow;
                RGraph.Effects.Gauge.Grow(gauge);
            }


            // Update for the last hour graph
	        function drawHourGraph(canvasId, jsonData, yMax, yLabelsCount) {
                RGraph.Reset(document.getElementById(canvasId));
                
                var labels = ['-60m','-50m','-40m','-30m','-20m','-10m','0']
                if (hour != 0) {
                	var startLabel = (hour < 11) ? '0' + (hour - 1) : (hour - 1);
                	var endLabel = (hour % 24 < 10) ? '0' + hour % 24 : hour % 24;
                	
                	labels = [startLabel + ':00', startLabel + ':10', startLabel + ':20', startLabel + ':30', startLabel + ':40', startLabel + ':50', endLabel + ':00'];
                }

                var line = new RGraph.Line(canvasId, jsonData.eLastHourList)
                	.Set('labels', labels)
                	.Set('chart.ylabels.count', yLabelsCount)
                	.Set('chart.numyticks', yLabelsCount)
                	.Set('chart.gutter.left', 50)
                	.Set('chart.units.post', ' W')
                	.Set('chart.scale.thousand', '')
             	    .Set('chart.linewidth', 2)
             	    .Set('chart.filled', true)
             	    .Set('chart.fillstyle', ['Gradient(#faa:rgba(0,0,0,0))'])
                	.Set('title', 'Verbruik laatste 60 minuten')
                	.Set('numxticks', 6)
                	.Set('background.grid.autofit.numhlines', yLabelsCount)
                	.Set('background.grid.autofit.numvlines', 12)
                	.Set('ymax', yMax)
                	.Draw();
            }
        	
            // show the day graph
            function drawDayGraphMinMaxAvg(canvasId, jsonData) { 
                var hourlyData = [];

                j = 0;
				for (i = 0; i < 24; ++i) {
					if ((jsonData.eHourlyMinList[i] != null) && (jsonData.eHourlyMaxList[i] != null)) {
						avg = jsonData.eHourlyMinList[i];
						if (jsonData.eHourlyTotalList[i] != null && jsonData.eHourlyTotalList[i + 1] != null) { 
							avg = jsonData.eHourlyTotalList[i + 1] - jsonData.eHourlyTotalList[i];
						}
						hourlyData[j] = [(i * 2) + 1, [jsonData.eDayMin, jsonData.eHourlyMinList[i], avg, jsonData.eHourlyMaxList[i], jsonData.eHourlyMaxList[i], 'gray', 'lightgray'], 'black'];
						j++;
					}
				}          
				
                scale = (jsonData.eDayMax >= 1000) ? 1000 : 100;
                yMax = scale + (jsonData.eDayMax - (jsonData.eDayMax % scale));
                yLabelsCount = yMax / scale;
                if (yLabelsCount <= 3) {
                	yLabelsCount *= 2;
                }

				RGraph.Reset(document.getElementById(canvasId));
	
				var scatterTitle = 'Minimum, maximum and gemiddelde per uur';
				var scatter = new RGraph.Scatter(canvasId, RGraph.array_clone(hourlyData))
					.Set('chart.title', scatterTitle)
					.Set('chart.background.grid.autofit.numhlines', yLabelsCount)
					.Set('chart.background.grid.autofit.numvlines', 24)
					.Set('chart.ylabels.count', yLabelsCount)
                	.Set('chart.numyticks', yLabelsCount)
					.Set('chart.boxplot.capped', false)
					.Set('chart.boxplot.width', 1)
					.Set('chart.labels', ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24'])
					.Set('chart.xmax', 48)
					.Set('chart.ymax', yMax)
					.Set('chart.gutter.left', 50)
					.Set('chart.units.post', ' W')
					.Set('chart.scale.thousand', '')
					.Set('chart.xaxis', false)
					.Draw();
			}

            
        	function showDay(number) {
        		if (day == number) {
        			// go back to current view        		
                    document.getElementById('btn_day_' + day).style.color = 'white';
					document.getElementById('btn_hour_' + hour).style.color = 'white';
        			day = 0;                                                                                       
        			hour = 0;
        		}
        		else {       
        			if (day != 0) {
                        document.getElementById('btn_day_' + day).style.color = 'white';
					}
                    document.getElementById('btn_day_' + number).style.color = 'black';
					if (hour == 0) {
						hour = 24;
						document.getElementById('btn_hour_' + hour).style.color = 'black';
					}
					day = number;
				}
				update();
        	}
        	
        	function showHour(number) {
        		if (hour != number) {
        			if (day == 0) {
        				// set day to current day; note that getDay start with Sunday = 0!
        				var d = new Date();
        				day = d.getDay();
        				if (day == 0) {
        					day = 7;
        				}
                        document.getElementById('btn_day_' + day).style.color = 'black';
        			}
        			if (hour != 0) {
						document.getElementById('btn_hour_' + hour).style.color = 'white';
					}
					document.getElementById('btn_hour_' + number).style.color = 'black';
					hour = number;
					update();
				}
        	}
        	
        </script>
        <footer>
            The graphs have been created using <a href="http://www.rgraph.net">www.rgraph.net</a>
        </footer>
	</body>
</html>

