<?xml version="1.0"?>
<!DOCTYPE html>
<html>
	<head>
		<title>Energiemeter</title>
		
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		
		<!-- 1/3. Include the RGraph libraries -->
		<script src="javascript/rgraph/RGraph.common.core.js" ></script>
		<script src="javascript/rgraph/RGraph.common.dynamic.js" ></script>
		<script src="javascript/rgraph/RGraph.common.effects.js" ></script>
		<script src="javascript/rgraph/RGraph.gauge.js" ></script>
		<script src="javascript/rgraph/RGraph.line.js" ></script>
		<script src="javascript/rgraph/RGraph.scatter.js" ></script>
		<script src="javascript/rgraph/RGraph.drawing.text.js" ></script>

	</head>
	<body>
	
		<div style="text-align: center">
			<canvas id="cvs0" width="475" height="300">[No canvas support]</canvas>
			<canvas id="cvs1" width="300" height="300">[No canvas support]</canvas><br /><br />
			<canvas id="cvs2" width="795" height="300">[No canvas support]</canvas><br /><br />
			<canvas id="cvs3" width="795" height="300">[No canvas support]</canvas><br /><br />
		</div>
		
		<!--
        	3/3. This creates and displays the graph. As it is here, you can call this from the window.onload event,
            allowing you to put it in your pages header.
        -->
        <script>
       		var gauge = null;
        	var previousMaxLastHour = 0;
	
            var dataSet = getParameterByName('set');
            if (dataSet == "") {
            	dataSet = 'data_0_0';
            }
        
        	window.onload = function ()
        	{
                update();
            }

			function update()
			{
				RGraph.AJAX.getJSON('data.php?set=' + dataSet, draw);
            
        		setTimeout(update, 10000);
			}

        	/**
        	 * This is the AJAX callback function. 
        	 */
        	function draw (jsonData)
        	{
                RGraph.Reset(document.getElementById('cvs0'));
        		
                var textSize = 14;
                var inbetweenLineSize = 10;
                var x1 = 40;
                var x2 = 400;
        		var y = 100;

        		new RGraph.Drawing.Text('cvs0', x1, y, 'Meeting:')
        			.Set('valign', 'bottom')
        			.Set('halign', 'left')
        			.Set('size', textSize)
        			.Draw();
        			
        		new RGraph.Drawing.Text('cvs0', x2, y, jsonData.timestamp)
        			.Set('valign', 'bottom')
        			.Set('halign', 'right')
        			.Set('size', textSize)
        			.Draw();
        			
        		y += textSize + inbetweenLineSize;
        		new RGraph.Drawing.Text('cvs0', x1, y, 'Elektra dag totaal:')
        			.Set('valign', 'bottom')
        			.Set('halign', 'left')
        			.Set('size', textSize)
        			.Draw();
        		
        		var dayTotal = '?';
        		if (jsonData.eHourlyTotalList[0] != null) {
        			dayTotal = (jsonData.eTotal - jsonData.eHourlyTotalList[0]) / 1000;
        		}
        		new RGraph.Drawing.Text('cvs0', x2, y, dayTotal.toString() + ' kWh')
        			.Set('valign', 'bottom')
        			.Set('halign', 'right')
        			.Set('size', textSize)
        			.Draw();
        		
        		y += textSize + inbetweenLineSize;
        		new RGraph.Drawing.Text('cvs0', x1, y, 'Elektra dag minimum:')
        			.Set('valign', 'bottom')
        			.Set('halign', 'left')
        			.Set('size', textSize)
        			.Draw();

        		new RGraph.Drawing.Text('cvs0', x2, y, jsonData.eDayMin.toString() + ' W')
        			.Set('valign', 'bottom')
        			.Set('halign', 'right')
        			.Set('size', textSize)
        			.Draw();
        		
        		y += textSize + inbetweenLineSize;
        		new RGraph.Drawing.Text('cvs0', x1, y, 'Elektra dag maximum:')
        			.Set('valign', 'bottom')
        			.Set('halign', 'left')
        			.Set('size', textSize)
        			.Draw();
        			
        		new RGraph.Drawing.Text('cvs0', x2, y, jsonData.eDayMax.toString() + ' W')
        			.Set('valign', 'bottom')
        			.Set('halign', 'right')
        			.Set('size', textSize)
        			.Draw();
        		

        		var maxLastHour = Math.max.apply(Math, jsonData.eLastHourList);
                var scale = (maxLastHour >= 1000) ? 1000 : 200;
                var yMax = scale + (maxLastHour - (maxLastHour % scale));
                var yLabelsCount = yMax / scale;
                if (yLabelsCount <= 3) {
                	yLabelsCount *= 2;
                }
        		
        		// Update gauge
        		if (maxLastHour != previousMaxLastHour) {
        			previousMaxLastHour = maxLastHour;
        			
        			RGraph.Reset(document.getElementById('cvs1'));
        			gauge = new RGraph.Gauge('cvs1', 0, yMax, 0)
        				.Set('title.top', 'Energie verbruik')
        				.Set('chart.scale.thousand', '')
        				.Set('chart.tickmarks.big', yLabelsCount)
        				.Set('chart.labels.count', yLabelsCount)
        				.Set('chart.tickmarks.small', yLabelsCount * 5);
        		}
        			
        		var text = jsonData.eNow + ' W';
                gauge.Set('title.bottom', text);
                gauge.value = jsonData.eNow;
                RGraph.Effects.Gauge.Grow(gauge);
                

                
                // Update for the last hour graph
                RGraph.Reset(document.getElementById('cvs2'));

                var line = new RGraph.Line('cvs2', jsonData.eLastHourList)
                	.Set('labels', ['60m','50m','40m','30m','20m','10m','0'])
                	.Set('chart.ylabels.count', yLabelsCount)
                	.Set('chart.numyticks', yLabelsCount)
                	.Set('chart.gutter.left', 50)
                	.Set('chart.units.post', ' W')
                	.Set('chart.scale.thousand', '')
             	    .Set('chart.linewidth', 2)
             	    .Set('chart.filled', true)
             	    .Set('chart.fillstyle', ['Gradient(#faa:rgba(0,0,0,0))'])
                	.Set('title', 'Verbruik laatste 60 minuten')
                	.Set('numxticks', 6)
                	.Set('background.grid.autofit.numhlines', yLabelsCount)
                	.Set('background.grid.autofit.numvlines', 12)
                	.Set('ymax', yMax)
                	.Draw();
                	
                	
                // Update for the hourly min/max graph
                // create the data
                
                var hourlyData = [];

                j = 0;
				for (i = 0; i < 24; ++i) {
					if ((jsonData.eHourlyMinList[i] != null) && (jsonData.eHourlyMaxList[i] != null)) {
						avg = jsonData.eHourlyMinList[i];
						if (jsonData.eHourlyTotalList[i] != null && jsonData.eHourlyTotalList[i + 1] != null) { 
							avg = jsonData.eHourlyTotalList[i + 1] - jsonData.eHourlyTotalList[i];
						}
						hourlyData[j] = [(i * 2) + 1, [jsonData.eDayMin, jsonData.eHourlyMinList[i], avg, jsonData.eHourlyMaxList[i], jsonData.eHourlyMaxList[i], 'gray', 'lightgray'], 'black'];
						j++;
					}
				}          
				
				//if (document.getElementById("cvs3").__object__) {
				//	RGraph.ObjectRegistry.Clear(document.getElementById("cvs3").__object__);
				//}
				
                scale = (jsonData.eDayMax >= 1000) ? 1000 : 100;
                yMax = scale + (jsonData.eDayMax - (jsonData.eDayMax % scale));
                yLabelsCount = yMax / scale;
                if (yLabelsCount <= 3) {
                	yLabelsCount *= 2;
                }

				
				RGraph.Reset(document.getElementById('cvs3'));
	
				var scatterTitle = 'Minimum, maximum and gemiddelde per uur';
				var scatter = new RGraph.Scatter('cvs3', RGraph.array_clone(hourlyData))
					.Set('chart.title', scatterTitle)
					.Set('chart.background.grid.autofit.numhlines', yLabelsCount)
					.Set('chart.background.grid.autofit.numvlines', 24)
					.Set('chart.ylabels.count', yLabelsCount)
                	.Set('chart.numyticks', yLabelsCount)
					.Set('chart.boxplot.capped', false)
					.Set('chart.boxplot.width', 1)
					.Set('chart.labels', ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24'])
					.Set('chart.xmax', 48)
					.Set('chart.ymax', yMax)
					.Set('chart.gutter.left', 50)
					.Set('chart.units.post', ' W')
					.Set('chart.scale.thousand', '')
					.Set('chart.xaxis', false)
					.Draw();
        	}
        	
        	function getParameterByName(name) {
        		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
        		var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        		results = regex.exec(location.search);
        		return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        	}
        	
        </script>

	</body>
</html>

