<?xml version="1.0"?>
<!DOCTYPE html>
<html>
	<head>
		<title>Energiemeter</title>
		
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		
		<!-- 1/3. Include the RGraph libraries -->
		<script src="javascript/rgraph/RGraph.common.core.js" ></script>
		<script src="javascript/rgraph/RGraph.common.effects.js" ></script>
		<script src="javascript/rgraph/RGraph.gauge.js" ></script>
		<script src="javascript/rgraph/RGraph.line.js" ></script>
		<script src="javascript/rgraph/RGraph.scatter.js" ></script>

	</head>
	<body>
	
		<h1>Energie verbruik</h1>

		<table border=1 cellpadding=5>
			<tr>
				<td>Datum</td>
				<td><div id="divLastUpdate">-</div></td>
			</tr>
			<tr>
				<td>Elektra dag totaal</td>
				<td><div id="divElektraDagTotaal">-</div></td>
			</tr>
			<tr>
				<td>Elektra dag minimum</td>
				<td><div id="divElektraDagMin">-</div></td>
			</tr>
			<tr>
				<td>Elektra dag maximum</td>
				<td><div id="divElektraDagMax">-</div></td>
			</tr>
		</table>


		<div style="text-align: center">
			<canvas id="cvs1" width="300" height="300">[No canvas support]</canvas><br /><br />
			<canvas id="cvs2" width="795" height="300">[No canvas support]</canvas><br /><br />
			<canvas id="cvs3" width="795" height="300">[No canvas support]</canvas><br /><br />
		</div>
		
		<!--
        	3/3. This creates and displays the graph. As it is here, you can call this from the window.onload event,
            allowing you to put it in your pages header.
        -->
        <script>
       		var gauge = new RGraph.Gauge('cvs1', 0, 5000, 0)
        		.Set('title.top', 'Energie verbruik')
        		.Set('chart.scale.thousand', '');
	
            //var hourlyData=[];

            var dataSet = getParameterByName('set');
            if (dataSet == "") {
            	dataSet = 'data_0';
            }
        
        	window.onload = function ()
        	{
	       		gauge.Draw();
	       		
                update();
            }

			function update()
			{
				RGraph.AJAX.getJSON('data.php?set=' + dataSet, draw);
            
        		setTimeout(update, 10000);
			}

        	/**
        	 * This is the AJAX callback function. 
        	 */
        	function draw (jsonData)
        	{
        		document.getElementById("divLastUpdate").innerHTML = jsonData.timestamp;
        		document.getElementById("divElektraDagTotaal").innerHTML = jsonData.eTotal - jsonData.eHourlyTotalList[0];
        		document.getElementById("divElektraDagMin").innerHTML = jsonData.eDayMin;
        		document.getElementById("divElektraDagMax").innerHTML = jsonData.eDayMax;
        		
        		var text = jsonData.eNow + ' W';
                gauge.Set('title.bottom', text);
                gauge.value = jsonData.eNow;
                RGraph.Effects.Gauge.Grow(gauge);

                var maxLastHour = Math.max.apply(Math, jsonData.eLastHourList);
   				var scaleMaxLastHourDataIn1000 = 1 + (maxLastHour - (maxLastHour % 1000)) / 1000; 


                // Update for the last hour graph
                RGraph.Reset(document.getElementById('cvs2'));

                var line = new RGraph.Line('cvs2', jsonData.eLastHourList)
                	.Set('labels', ['60m','50m','40m','30m','20m','10m','0'])
                	.Set('chart.ylabels.count', scaleMaxLastHourDataIn1000)
                	.Set('chart.numyticks', scaleMaxLastHourDataIn1000 * 2)
                	.Set('chart.gutter.left', 50)
                	.Set('chart.units.post', ' W')
                	.Set('chart.scale.thousand', '')
             	    .Set('chart.linewidth', 2)
             	    .Set('chart.filled', true)
             	    .Set('chart.fillstyle', ['Gradient(#faa:rgba(0,0,0,0))'])
                	.Set('title', 'Verbruik laatste uur')
                	.Set('numxticks', 6)
                	.Set('background.grid.autofit.numhlines', 2 * scaleMaxLastHourDataIn1000)
                	.Set('background.grid.autofit.numvlines', 12)
                	.Set('ymax', scaleMaxLastHourDataIn1000 * 1000)
                	.Draw();
                	
                	
                // Update for the hourly min/max graph
                // create the data
                
                var hourlyData = [];

                j = 0;
				for (i = 0; i < 24; ++i) {
					if ((jsonData.eHourlyMinList[i] != null) && (jsonData.eHourlyMaxList[i] != null)) {
						hourlyData[j] = [(i * 2) + 1, [jsonData.eDayMin, jsonData.eHourlyMinList[i], jsonData.eHourlyMinList[i], jsonData.eHourlyMaxList[i], jsonData.eHourlyMaxList[i], 'gray', 'lightgray'], 'black'];
						j++;
					}
				}          
				// find scale
				var scaleMaxHourlyDataIn1000 = 1 + (jsonData.eDayMax - (jsonData.eDayMax % 1000)) / 1000; 
				
				//if (document.getElementById("cvs3").__object__) {
				//	RGraph.ObjectRegistry.Clear(document.getElementById("cvs3").__object__);
				//}
				RGraph.Reset(document.getElementById('cvs3'));
	
				var scatter = new RGraph.Scatter('cvs3', RGraph.array_clone(hourlyData))
					.Set('chart.title', 'Min / Max en gemiddelde per uur')
					.Set('chart.background.grid.autofit.numhlines', scaleMaxHourlyDataIn1000)
					.Set('chart.background.grid.autofit.numvlines', 24)
					.Set('chart.ylabels.count', scaleMaxHourlyDataIn1000)
                	.Set('chart.numyticks', scaleMaxHourlyDataIn1000)
					.Set('chart.boxplot.capped', false)
					.Set('chart.boxplot.width', 1)
					.Set('chart.labels', ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24'])
					.Set('chart.xmax', 48)
					.Set('chart.ymax', scaleMaxHourlyDataIn1000 * 1000)
					.Set('chart.gutter.left', 50)
					.Set('chart.units.post', ' W')
					.Set('chart.scale.thousand', '')
					.Set('chart.xaxis', false)
					.Draw();
        	}
        	
        	function getParameterByName(name) {
        		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
        		var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        		results = regex.exec(location.search);
        		return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        	}
        	
        </script>

	</body>
</html>

